{% extends 'admin/master.html' %}
{% import 'admin/lib.html' as lib with context %}
{% import 'admin/static.html' as admin_static with context %}
{% import 'admin/model/layout.html' as model_layout with context %}

{% block head %}
  {{ super() }}
{% endblock %}

{% block body %}
  <h2>Dashboard</h2>
  {{ data.table_names }}
  <h4>Bills Summary</h4>
  <li><strong>Last Bill Run: </strong>
    {% if data.bill_last_run %}
      {{ data.bill_last_run.dag_id }} at {{ data.bill_last_run_time.pst_time }} PST ({{ data.bill_last_run_time.cst_time }} CST)
    {% else %}
      No Bill Scrapes Completed
    {% endif %}
  </li>
  <li><strong>Upcoming Bill Run: </strong>
    {% if data.bill_next_run %}
      {{ data.bill_next_run.dag_id }} at {{ data.bill_next_run_time.pst_time }} PST ({{ data.bill_next_run_time.cst_time }} CST)
    {% else %}
      No Bill Scrapes Scheduled
    {% endif %}
  </li>
  <li><strong>Bills in Search Index: </strong>{{ data.bills_in_index }}</li>
  <h4>Events Summary</h4>
  <li><strong>Last Event Run: </strong>
    {% if data.event_last_run %}
      {{ data.event_last_run.dag_id }} at {{data.event_last_run_time.pst_time }} PST ({{ data.bill_last_run_time.cst_time }} CST)
    {% else %}
      No Event Scrapes Completed
    {% endif %}
  </li>
  <li><strong>Upcoming Event Run: </strong>
    {% if data.event_next_run %}
      {{ data.event_next_run.dag_id }} at {{ data.event_next_run_time.pst_time }} PST ({{ data.event_next_run_time.cst_time }} CST)
    {% else %}
      No Event Scrapes Scheduled
    {% endif %}
  </li>
  <ul><h4>Bills Overview:</h4>
    <li><strong>Last Bill Run: </strong>
      {% if data.bill_last_run %}
        {{ data.bill_last_run.dag_id }} at {{ data.bill_last_run_time.pst_time }} PST ({{ data.bill_last_run_time.cst_time }} CST)</li>
      {% else %}
        No Bill Scrapes Completed </li>
      {% endif %}
    <li><strong>Upcoming Bill Run: </strong>
      {% if data.bill_next_run %}
        {{ data.bill_next_run.dag_id }} at {{ data.bill_next_run_time.pst_time }} PST ({{ data.bill_next_run_time.cst_time }} CST)</li>
      {% else %}
        No Bill Scrapes Scheduled </li>
      {% endif %}
  </ul>
  <ul><h4>Events Overview:</h4>
    <li><strong>Last Event Run: </strong>
      {% if data.event_last_run %}
        {{ data.event_last_run.dag_id }} at {{data.event_last_run_time.pst_time }} PST ({{ data.bill_last_run_time.cst_time }} CST)</li>
      {% else %}
        No Event Scrapes Completed </li>
      {% endif %}
      <li><strong>Upcoming Event Run: </strong>
      {% if data.event_next_run %}
        {{ data.event_next_run.dag_id }} at {{ data.event_next_run_time.pst_time }} PST ({{ data.event_next_run_time.cst_time }} CST)</li>
      {% else %}
        No Event Scrapes Scheduled </li>
      {% endif %}
  </ul>

  {% block model_list_table %}
    <table class='table table-striped table-bordered table-hover model-list' id='dashboard-table'>
      <thead>
        <tr>
          <th class='column-header'>Name</th>
          <th class='column-header'>Most Recent Run Status</th>
          <th class='column-header'>Most Recent Run Date</th>
          <th class='column-header'>Next Scheduled</th>
        </tr>
      </thead>

      {% for dag in data.data %}
        <tr>
          <td><strong>{{ dag.name }} </strong><br />
            <u><span class="dag-description" id="{{ loop.index }}">Click for More Info</span></u><br />
            <span class="description-text" id="text-{{ loop.index }}"> {{ dag.description }}</span>
          </td>
          {% if dag.run_state == 'failed' %}
            <td class="text-center"><span style="color: red"><i class="fas fa-times-circle"></i></span></td>
          {% elif dag.run_state == 'success' %}
            <td class="text-center"><span style="color: green"><i class="fas fa-check-circle"></i></span></td>
          {% else %}
            <td>{{ dag.run_state }}</td>
          {% endif %}

          {% if dag.run_date != None %}
            <td>{{ dag.run_date.pst_time }} PST<br /> {{ dag.run_date.cst_time }} CST</td>
          {% else %}
            <td></td>
          {% endif %}
          {% if dag.next_scheduled != None %}
            <td>{{ dag.next_scheduled.pst_time }} PST<br /> {{ dag.next_scheduled.cst_time }} CST</td>
          {% else %}
            <td></td>
          {% endif %}
        </tr>
      {% endfor %}
    </table>
  {% endblock %}

{% endblock %}

{% block tail %}
  {{ super() }}
  <link href="/a{{ url_for('static', filename='css/datatables.min.css') }}" rel="stylesheet">
  <script src="/a{{ url_for('static', filename='js/datatables.min.js') }}"></script>
  <script src="https://use.fontawesome.com/releases/v5.13.0/js/all.js" data-auto-replace-svg="nest"></script>
  <script type="text/javascript">
    $(document).ready(function() {
      $('.navbar-header a.navbar-brand').attr('href', '/admin/dashboard/')
      $('.navbar-nav').hide()
      $('.navbar-right').show()

      $('.description-text').hide()

      $('#dashboard-table').DataTable({
        "order": [[2, "desc"]],
        "table-layout": "fixed",
        "columnDefs": [
            { "width": 300, "targets": 0 }
        ],
        "fixedColumns": true
      });
      
    });

    $('.dag-description').click(function() {
      currentSpan = $(`#${this.id}`)
      currentText = currentSpan.text()
      if (currentText.includes("More")) { 
        currentSpan.text(function() {
          return "Click for Less Info"
        })
        $(`#text-${this.id}`).show()
      } else {
        currentSpan.text(function() {
          return `Click for More Info`
        })
        $(`#text-${this.id}`).hide()
      }
    })

  </script>
  {{ lib.form_js() }}
{% endblock %}
